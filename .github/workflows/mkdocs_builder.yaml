name: Docs Auto Builder

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:  # å®šæ—¶è§¦å‘
    - cron: '0 */2 * * *'  # æ¯ä¸¤å°æ—¶è¿è¡Œä¸€æ¬¡

permissions:
  contents: write  # ä»£ç å†™å…¥æƒé™
  pages: write     # Pageséƒ¨ç½²æƒé™

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production  # æ¨èå…³è”ç”Ÿäº§ç¯å¢ƒ
    concurrency: 
      group: "docs-deploy-${{ github.ref }}"  # é˜²æ­¢å¹¶å‘å†²çª

    steps:
      - name: ğŸ›  Checkout Repository
        uses: actions/checkout@v4
        with:
          path: 'src'  # æŒ‡å®šæ£€å‡ºç›®å½•
          persist-credentials: false  # ç¦ç”¨é»˜è®¤å‡­è¯

      - name: ğŸ”‘ Configure SSH Access
        if: github.ref == 'refs/heads/main'  # ä»…ä¸»åˆ†æ”¯éœ€è¦éƒ¨ç½²
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: ğŸ Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'  # å¯ç”¨ä¾èµ–ç¼“å­˜

      - name: ğŸ“¦ Install Dependencies
        working-directory: ./src/mkdocs_builder
        run: |
          pip install --cache-dir .pip_cache -r requirements.txt

      - name: ğŸš€ Build Documentation
        env:
          GIT_AUTHOR_NAME: "only9464"
          GIT_COMMITTER_EMAIL: "only9464@qq.com"
        working-directory: ./src/mkdocs_builder
        run: |
          # é…ç½®å…¨å±€Gitèº«ä»½
          git config --global user.name "$GIT_AUTHOR_NAME"
          git config --global user.email "$GIT_COMMITTER_EMAIL"
          
          # è®¾ç½®SSHè®¤è¯
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no"
          
          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          chmod +x update_and_deploy.sh
          ./update_and_deploy.sh

          # æ¸…ç†æ•æ„Ÿä¿¡æ¯
          unset GIT_SSH_COMMAND